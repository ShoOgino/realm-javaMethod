    @Override
    public void run() {
        Looper.prepare();

        handler = new Handler() {
            @Override
            public void handleMessage(Message message) {
                if (message.arg1 == REALM_CHANGED) {
                    for (Map.Entry<Handler, Integer> entry : handlers.entrySet()) {
                        if (entry.getValue() == message.arg2) {
                            Handler currentHandler = entry.getKey();
                            if (currentHandler.getLooper().getThread().isAlive() &&
                                !currentHandler.hasMessages(REALM_CHANGED))
                            {
                                try {
                                    currentHandler.sendEmptyMessage(REALM_CHANGED);
                                } catch (RuntimeException e) {
                                    exceptions.add(e);
                                    Log.w(TAG, e.getMessage());
                                }
                            }
                        }
                    }
                }
            }
        };

        Looper.loop();
    }

