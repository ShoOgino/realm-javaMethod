    private void emitCreateDetachedCopyMethod(JavaWriter writer) throws IOException {
        writer.beginMethod(
                className, // Return type
                "createDetachedCopy", // Method name
                EnumSet.of(Modifier.PUBLIC, Modifier.STATIC), // Modifiers
                className, "realmObject", "int", "currentDepth", "int", "maxDepth", "Map<RealmObject, CacheData<RealmObject>>", "cache");
        writer
            .beginControlFlow("if (currentDepth > maxDepth || realmObject == null)")
                .emitStatement("return null")
            .endControlFlow()
            .emitStatement("CacheData<%s> cachedObject = (CacheData) cache.get(realmObject)", className)
            .emitStatement("%s standaloneObject", className)
            .beginControlFlow("if (cachedObject != null)")
                .emitSingleLineComment("Reuse cached object or recreate it because it was encountered at a lower depth.")
                .beginControlFlow("if (currentDepth >= cachedObject.minDepth)")
                    .emitStatement("return cachedObject.object")
                .nextControlFlow("else")
                    .emitStatement("standaloneObject = cachedObject.object")
                    .emitStatement("cachedObject.minDepth = currentDepth")
                .endControlFlow()
            .nextControlFlow("else")
                .emitStatement("standaloneObject = new %s()", className)
                .emitStatement("cache.put(realmObject, new RealmObjectProxy.CacheData<RealmObject>(currentDepth, standaloneObject))")
            .endControlFlow();

        writer.emitStatement("Class<?> clazz = standaloneObject.getClass()");
        writer.emitStatement("Field field = null");

        for (VariableElement field : metadata.getFields()) {
            String fieldName = field.getSimpleName().toString();
            String getter = metadata.getGetter(fieldName);

            writer.beginControlFlow("try");
            writer.emitStatement("field = clazz.getDeclaredField(\"%s\")", fieldName);
            writer.nextControlFlow("catch (NoSuchFieldException e)");
            writer.emitStatement("throw new RealmException(e.getMessage())");
            writer.endControlFlow();
            writer.emitStatement("field.setAccessible(true)");

            if (Utils.isRealmObject(field)) {
                writer
                    .emitEmptyLine()
                    .emitSingleLineComment("Deep copy of %s", fieldName)
                    .beginControlFlow("try")
                        .emitStatement("field.set(standaloneObject, %s.createDetachedCopy( ((%sRealmProxy) " +
                                "realmObject).%s(), currentDepth + 1, maxDepth, cache))",
                            Utils.getProxyClassSimpleName(field), className, getter)
                    .nextControlFlow("catch (IllegalAccessException e)")
                        .emitStatement("throw new RealmException(e.getMessage())")
                    .endControlFlow();
            } else if (Utils.isRealmList(field)) {
                writer
                    .emitEmptyLine()
                    .emitSingleLineComment("Deep copy of %s", fieldName)
                    .beginControlFlow("if (currentDepth == maxDepth)")
                        .beginControlFlow("try")
                            .emitStatement("field.set(standaloneObject, null)")
                        .nextControlFlow("catch (IllegalAccessException e)")
                            .emitStatement("throw new RealmException(e.getMessage())")
                        .endControlFlow()
                    .nextControlFlow("else")
                        .emitStatement("RealmList<%s> managed%sList = ((%sRealmProxy) realmObject).%s()",
                                Utils.getGenericType(field), fieldName, className, getter)
                        .emitStatement("RealmList<%1$s> standalone%2$sList = new RealmList<%1$s>()", Utils.getGenericType(field), fieldName)
                        .beginControlFlow("try")
                            .emitStatement("field.set(standaloneObject, standalone%sList)", fieldName)
                        .nextControlFlow("catch (IllegalAccessException e)")
                            .emitStatement("throw new RealmException(e.getMessage())")
                        .endControlFlow()
                        .emitStatement("int nextDepth = currentDepth + 1")
                        .emitStatement("int size = managed%sList.size()", fieldName)
                        .beginControlFlow("for (int i = 0; i < size; i++)")
                            .emitStatement("%s item = %s.createDetachedCopy(managed%sList.get(i), nextDepth, maxDepth, cache)",
                                    Utils.getGenericType(field), Utils.getProxyClassSimpleName(field), fieldName)
                            .emitStatement("standalone%sList.add(item)", fieldName)
                        .endControlFlow()
                    .endControlFlow();
            } else {
                writer.beginControlFlow("try");
                writer.emitStatement("field.%s(standaloneObject, ((%sRealmProxy) realmObject).%s())",
                        Constants.JAVA_TO_FIELD_SETTER.get(field.asType().toString()), className, getter);
                writer.nextControlFlow("catch (IllegalAccessException e)");
                writer.emitStatement("throw new RealmException(e.getMessage())");
                writer.endControlFlow();

            }
        }

        writer.emitStatement("return standaloneObject");
        writer.endMethod();
        writer.emitEmptyLine();
    }

