    @Test
    @RunTestInLooperThread(emulateMainThread = true)
    public void permissionManagerAsyncTask_keepReportingFatalErrors() throws NoSuchFieldException, IllegalAccessException {
        PermissionManager pm = user.getPermissionManager();
        looperThread.closeAfterTest(pm);

        // Simulate fatal error in the management Realm that is not possible to recover from
        // This should be reported for all tasks, not just the first one.
        setRealmError(pm, "managementRealmError", new ObjectServerError(ErrorCode.WRONG_PROTOCOL_VERSION, "Boom1"));

        pm.getPermissions(new PermissionManager.PermissionsCallback() {
            @Override
            public void onSuccess(RealmResults<Permission> permissions) {
                fail();
            }

            @Override
            public void onError(ObjectServerError error) {
                assertEquals(ErrorCode.WRONG_PROTOCOL_VERSION, error.getErrorCode());
                pm.getPermissions(new PermissionManager.PermissionsCallback() {
                    @Override
                    public void onSuccess(RealmResults<Permission> permissions) {
                        fail();
                    }

                    @Override
                    public void onError(ObjectServerError error) {
                        assertEquals(ErrorCode.WRONG_PROTOCOL_VERSION, error.getErrorCode());
                        looperThread.testComplete();
                    }
                });
            }
        });
    }

