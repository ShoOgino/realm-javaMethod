    private static void initializeRealm(Realm realm) {
        // Everything in this method needs to be behind a transaction lock to prevent multi-process interaction while
        // the Realm is initialized.
        boolean commitChanges = false;
        try {
            realm.beginTransaction();
            long currentVersion = realm.getVersion();
            boolean unversioned = currentVersion == UNVERSIONED;
            commitChanges = unversioned;

            RealmConfiguration configuration = realm.getConfiguration();

            if (unversioned) {
                realm.setVersion(configuration.getSchemaVersion());
            }

            final RealmProxyMediator mediator = configuration.getSchemaMediator();
            final Set<Class<? extends RealmModel>> modelClasses = mediator.getModelClasses();

            if (unversioned) {
                // Create all of the tables.
                for (Class<? extends RealmModel> modelClass : modelClasses) {
                    mediator.createRealmObjectSchema(modelClass, realm.getSchema());
                }
            }

            final Map<Class<? extends RealmModel>, ColumnInfo> columnInfoMap = new HashMap<>(modelClasses.size());
            for (Class<? extends RealmModel> modelClass : modelClasses) {
                // Now that they have all been created, validate them.
                columnInfoMap.put(modelClass, mediator.validateTable(modelClass, realm.sharedRealm, false));
            }

            realm.getSchema().setColumnIndices(
                    (unversioned) ? configuration.getSchemaVersion() : currentVersion,
                    columnInfoMap);

            if (unversioned) {
                final Transaction transaction = configuration.getInitialDataTransaction();
                if (transaction != null) {
                    transaction.execute(realm);
                }
            }
        } catch (Exception e) {
            commitChanges = false;
            throw e;
        } finally {
            if (commitChanges) {
                realm.commitTransaction();
            } else {
                realm.cancelTransaction();
            }
        }
    }

