    static Realm createAndValidate(RealmConfiguration configuration, ColumnIndices[] globalCacheArray) {
        Realm realm = new Realm(configuration);
        long currentVersion = realm.getVersion();
        long requiredVersion = configuration.getSchemaVersion();
        final ColumnIndices columnIndices = RealmCache.findColumnIndices(globalCacheArray, requiredVersion);
        if (currentVersion != UNVERSIONED && currentVersion < requiredVersion && columnIndices == null) {
            realm.doClose();
            throw new RealmMigrationNeededException(configuration.getPath(), String.format("Realm on disk need to migrate from v%s to v%s", currentVersion, requiredVersion));
        }
        if (currentVersion != UNVERSIONED && requiredVersion < currentVersion && columnIndices == null) {
            realm.doClose();
            throw new IllegalArgumentException(String.format("Realm on disk is newer than the one specified: v%s vs. v%s", currentVersion, requiredVersion));
        }

        // Initialize Realm schema if needed
        if (columnIndices == null) {
            try {
                initializeRealm(realm);
            } catch (RuntimeException e) {
                realm.doClose();
                throw e;
            }
        } else {
            // copy global cache as a Realm local indices cache
            realm.schema.columnIndices = columnIndices.clone();
        }

        return realm;
    }

