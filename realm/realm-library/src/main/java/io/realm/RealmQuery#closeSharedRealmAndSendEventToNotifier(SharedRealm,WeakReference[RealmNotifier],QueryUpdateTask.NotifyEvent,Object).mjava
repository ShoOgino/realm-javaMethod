    // The shared group needs to be closed before sending the message to other threads to avoid timing problems.
    // eg.: The other thread wants to delete Realm when getting notified.
    private void closeSharedRealmAndSendEventToNotifier(SharedRealm sharedRealm,
                                                         WeakReference<RealmNotifier> weakNotifier,
                                                        QueryUpdateTask.NotifyEvent event, Object obj) {
        if (sharedRealm != null) {
            sharedRealm.close();
        }

        RealmNotifier notifier = weakNotifier.get();
        if (notifier!= null) {
            switch (event) {
                case COMPLETE_ASYNC_RESULTS:
                    notifier.completeAsyncResults((QueryUpdateTask.Result)obj);
                    break;
                case COMPLETE_ASYNC_OBJECT:
                    notifier.completeAsyncObject((QueryUpdateTask.Result)obj);
                    break;
                case THROW_BACKGROUND_EXCEPTION:
                    notifier.throwBackgroundException((Throwable)obj);
                    break;
                default:
                    // Should not get here.
                    throw new IllegalStateException(String.format("%s is not handled here.", event));
            }
        }
    }

