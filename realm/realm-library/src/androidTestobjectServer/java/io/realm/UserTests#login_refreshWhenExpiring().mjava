    // Tests that if a user logs in, the refreshToken is refreshed before it expires.
    @RunTestInLooperThread
    @Test
    public void login_refreshWhenExpiring() {
        // Setup server responses
        // Expires in 30 seconds and Refresh starts 30 seconds before it expires. This should trigger a refresh
        // immediately.
        long expires = System.currentTimeMillis() + TimeUnit.SECONDS.toMillis(30);
        AuthenticationServer authServer = Mockito.mock(AuthenticationServer.class);
        when(authServer.loginUser(any(Credentials.class), any(URL.class))).thenReturn(SyncTestUtils.createLoginResponse(expires));
        when(authServer.refreshUser(any(Token.class), any(URL.class))).then(new Answer<AuthenticateResponse>() {
            @Override
            public AuthenticateResponse answer(InvocationOnMock invocation) throws Throwable {
                looperThread.testComplete();
                return SyncTestUtils.createRefreshResponse();
            }
        });

        // Login (which will trigger a refreshUser)
        SyncManager.setAuthServerImpl(authServer);
        User.login(Credentials.facebook("foo"), "http://bar.com/auth");
    }

